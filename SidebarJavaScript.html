<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  var header_timeout_id = 0;
  var data_timeout_id = 0;
  var docid_timeout_id = 0;

  $(function() {
    // Assign handler functions to sidebar elements here, if needed.
    $('#sidebar-check-button').click(onCheckClick);
    $('#sidebar-push-button').click(onPushClick);
    $('#sidebar-push-button').disabled = true;
    google.script.run
        .withSuccessHandler(function(msg) { showStatus(''); $('#sidebar-index').val(msg); })
        .getSheetName();
    google.script.run
        .withSuccessHandler(function(msg) {
          showStatus('');
          $('#sidebar-header-range').val(msg[0]);
          $('#sidebar-data-range').val(msg[1]);
        })
        .getDefaultRanges();

    $('#sidebar-data-range').focus(onDataChange);
    $('#sidebar-data-range').keyup(onDataChange);
    $('#sidebar-header-range').focus(onHeaderChange);
    $('#sidebar-header-range').keyup(onHeaderChange);

    $('#sidebar-docid-range').focus(onDocIdChange);
    $('#sidebar-docid-range').keyup(onDocIdChange);
  });

  function updateSpreadsheetHighlight(element_id) {
    var new_value = $('#'+element_id).val();
    if(new_value) {
      if(new_value.length == 1) {
        new_value += ":"+new_value;
      }
      google.script.run
        .withSuccessHandler(function(msg) {
          showStatus('');
          validateData();
        })
        .withFailureHandler(function(msg) {
          showStatus(msg, 'error');
        })
        .highlightData(new_value);
    }
  }

  function onDataChange() {
    clearTimeout(data_timeout_id);
    data_timeout_id = setTimeout(function() {
      updateSpreadsheetHighlight('sidebar-data-range');
    }, 500);
  }

  function onHeaderChange() {
    clearTimeout(header_timeout_id);
    header_timeout_id = setTimeout(function() {
      updateSpreadsheetHighlight('sidebar-header-range');
    }, 500);
  }

  function onDocIdChange() {
    clearTimeout(docid_timeout_id);
    docid_timeout_id = setTimeout(function() {
      updateSpreadsheetHighlight('sidebar-docid-range');
    }, 500);
  }

  /**
   * Calls the server to retrieve information from the sheet.
   * Gets the value in the active cell, which is then placed in the
   * sidebar text field.
   */
  function onCheckClick() {
    this.disabled = true;
    var host = {
      host : $('#sidebar-host').val().trim(),
      port : $('#sidebar-port').val(),
      username : $('#sidebar-user').val(),
      password : $('#sidebar-pass').val(),
      use_ssl : $('#sidebar-ssl').is(':checked')
    };

    google.script.run
      .withSuccessHandler(
        function(msg, element) {
          $('#sidebar-value').val(msg);
          showStatus('Success!');
          element.disabled = false;
          $('#sidebar-push-button').disabled = false;
          $('#index-details').removeClass();
          validateData();
        })
      .withFailureHandler(
        function(msg, element) {
          showStatus(msg, 'error');
          element.disabled = false;
        })
      .withUserObject(this)
      .checkClusterConnection(host);
  }

  /**
   * Calls the server to modify the sheet.
   * Replace the currently selected cell value with the value in the
   * sidebar text field.
   */
  function onPushClick() {
    this.disabled = true;

    var host = {
      host : $('#sidebar-host').val().trim(),
      port : $('#sidebar-port').val(),
      username : $('#sidebar-user').val(),
      password : $('#sidebar-pass').val(),
      use_ssl : $('#sidebar-ssl').is(':checked')
    };

    var index = $('#sidebar-index').val();
    var index_type = $('#sidebar-type').val();
    var template_name = $('#sidebar-template').val();

    var header_range = $('#sidebar-header-range').val();
    var data_range = $('#sidebar-data-range').val();
    var doc_id_range = $('#sidebar-docid-range').val();

    google.script.run
      .withSuccessHandler(
        function(msg, element) {
          showStatus('Successfully pushed data to cluster.');
          element.disabled = false;
        })
      .withFailureHandler(
        function(msg, element) {
          showStatus(msg, 'error');
          element.disabled = false;
        })
        .withUserObject(this)
        .pushDataToCluster(host,index,index_type,template_name,header_range,data_range,doc_id_range);
  }

  function validateData() {
    var new_value = $('#sidebar-data-range').val();
    google.script.run
      .withSuccessHandler(
        function(msg) {
          showStatus('');
        })
      .withFailureHandler(function(msg) {
        showStatus(msg, 'error');
      })
      .validateData(new_value);
  }

  /**
   * Displays the given status message in the sidebar.
   *
   * @param {String} msg The status message to display.
   * @param {String} classId The message type (class id) that the message
   *   should be displayed as.
   */
  function showStatus(msg, classId) {
    $('#sidebar-status').removeClass().html(msg);
    if (classId) {
      $('#sidebar-status').addClass(classId);
    }
  }

</script>
